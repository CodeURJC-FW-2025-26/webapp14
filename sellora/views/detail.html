<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SellOra</title>
    {{> partials/head}}
</head>

{{> partials/header}}

<button class="btn-custom back-btn" onclick="window.location.href='/'">Go Back</button>

<body style="background-color: #9ba4b8;">
    <main class="container py-4">
        <div class="product-card">
            <img src="{{product.image}}" class="product-image" alt="{{product.title}}">
            <div class="product-details">
                <div>
                    <div class="product-name">{{product.title}}</div>
                    <div class="product-description">{{product.text}}</div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="product-price mb-0">{{product.price}}€</div>
                    <div class="review-actions">
                        <a href="/product/{{product._id}}/edit" class="btn btn-custom me-2">Edit</a>
                        <button onclick="deleteProduct('{{product._id}}')" class="btn btn-custom me-2">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <form id="review-form" class="review-form" novalidate onsubmit="submitReview(event, '{{product._id}}')">
            <h3>Leave your review!</h3>

            <div class="mb-3">
                <input type="text" id="review-author" name="author" class="review-textarea form-control" placeholder="Your name" required>
                <div class="invalid-feedback">Please enter your name.</div>
            </div>

            <div class="mb-3">
                <input type="text" id="review-text" name="text" class="review-textarea form-control" placeholder="Write your review here..." required>
                <div class="invalid-feedback">Please write a review text.</div>
            </div>

            <div class="mb-3">
                <select id="review-rating" name="rating" class="form-select" required>
                    <option value="" selected disabled>Select rating</option>
                    <option>⭐⭐⭐⭐⭐</option>
                    <option>⭐⭐⭐⭐☆</option>
                    <option>⭐⭐⭐☆☆</option>
                    <option>⭐⭐☆☆☆</option>
                    <option>⭐☆☆☆☆</option>
                </select>
                <div class="invalid-feedback">Please select a rating.</div>
            </div>

            <button type="submit" class="btn btn-custom me-2">Upload</button>
            
            <!-- Loading Spinner -->
            {{#reviewSpinner}}
              {{> partials/spinner}}
            {{/reviewSpinner}}
        </form>

        <div id="reviews-container">
            {{#product.reviews}}
            <div class="review-card" id="review-{{_id}}" data-author="{{author}}" data-text="{{text}}" data-rating="{{rating}}">

                <div class="review-view">
                    <div class="review-header">
                        <div class="review-author">{{author}}</div>
                    </div>

                    <div class="review-content">“{{text}}”</div>

                    <div class="review-rating">{{rating}}</div>

                    <div class="review-actions">
                        <button onclick="editReview('{{_id}}')" class="btn btn-custom me-2">Edit</button>
                        <button class="btn btn-custom me-2 btn-delete-review" 
                                data-product-id="{{product._id}}" 
                                data-review-id="{{_id}}">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            {{/product.reviews}}
    
    <!-- Edit Review Spinner -->
    <div id="loading-indicator" class="text-center" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2);">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 mb-0" id="spinner-text">Updating review...</p> 
    </div>
        </div>
    </main>

    <!-- Error Modal for Reviews -->
    <div class="modal fade" id="errorReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="errorReviewMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal for Product -->
    <div class="modal fade" id="errorProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="errorProductMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Product Modal -->
    <div class="modal fade" id="confirmDeleteProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this product?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteProductBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Review Modal -->
    <div class="modal fade" id="confirmDeleteReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this review?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteReviewBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>

    {{>partials/footer}}
</body>
</html>